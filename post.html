<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>帖子详情</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const postId = new URLSearchParams(location.search).get('id');
        
        const { data: post } = await supabase
            .from('posts')
            .select('*')
            .eq('id', postId)
            .single();

        const detailContainer = document.getElementById('postDetail');
        if (!post) {
            detailContainer.innerHTML = '<p>帖子未找到</p>';
            return;
        }

        // 构建详情内容
        let htmlContent = `
            <h2>${post.title}</h2>
            <div class="post-meta-grid">
                <div><strong>版本：</strong>${post.version}</div>
                ${post.loader ? `<div><strong>加载器：</strong>${post.loader}</div>` : ''}
                <div><strong>发布时间：</strong>${post.created_at}</div>
                <div><strong>游戏类型：</strong>${post.game_type}</div>
                <div><strong>联机类型：</strong>${post.server_type}</div>
                <div><strong>联机方式：</strong>${post.connection_type}</div>
                <div><strong>存档类型：</strong>${post.save_type}</div>
                ${post.retention_time ? `<div><strong>留存时间：</strong>${formatRetentionTime(post.retention_time)}</div>` : ''}
            </div>
            <div class="post-content-section">
                <h3>联机详情：</h3>
                <div class="content-box">${post.content.replace(/\n/g, '<br>')}</div>
            </div>
        `;

        if (post.playstyles) {
            htmlContent += `
                <div class="playstyle-section">
                    <h3>玩法标签：</h3>
                    <div class="tag-container">
                        ${post.playstyles.split(', ').map(t => `<span class="tag">${t}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        htmlContent += `
            <div class="contact-section">
                <h3>📧 联系方式：</h3>
                <div class="contact-box">${post.contact}</div>
            </div>
        `;

        detailContainer.innerHTML = htmlContent;
      });

      // 辅助函数：转换留存时间为可读格式
      function formatRetentionTime(minutes) {
          const periods = [
              { value: 525600, unit: '年' },  // 1年
              { value: 43200, unit: '月' },    // 1月
              { value: 10080, unit: '周' },    // 7天
              { value: 1440, unit: '天' }      // 1天
          ];
          
          for (let period of periods) {
              if (minutes >= period.value) {
                  return `${Math.floor(minutes/period.value)}${period.unit}`;
              }
          }
          return `${minutes}分钟`;
      }

      async function submitPost() {
          const title = document.getElementById('title').value;
          const content = document.getElementById('content').value;
          
          // 替换原来的localStorage代码
          const { data, error } = await supabase
              .from('posts')
              .insert([{ title, content }])
              .select()

          if (error) {
              console.error('提交失败:', error);
          } else {
              window.location.href = 'browse.html';
          }
      }
    </script>
</head>
<body>
    <div class="container">
        <h1>帖子详情</h1>
        <div class="post-container">
            <h2 id="post-title"></h2>
            <div class="post-meta">
                <span id="post-author"></span>
                <span id="post-time"></span>
            </div>
            <div class="post-content" id="post-content"></div>
        </div>
        <button onclick="window.history.back()">返回</button>
        <button class="report-btn" data-post-id="{{POST_ID}}">举报</button>
    </div>
</body>
</html> 